<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReefControl - Servidor NTP</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f7fa;min-height:100vh}
.header{background:#4a90e2;color:white;padding:1rem;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:1.5rem}
.back-btn{background:rgba(255,255,255,0.2);border:none;color:white;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:0.5rem}
.container{padding:1rem;max-width:800px;margin:0 auto}
.config-section{background:white;padding:2rem;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:2rem}
.section-title{font-weight:bold;font-size:1.2rem;margin-bottom:1.5rem;color:#333;border-bottom:2px solid #4a90e2;padding-bottom:0.5rem}
.form-group{margin-bottom:1.5rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:bold;color:#555}
.form-group input,.form-group select{width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:5px;font-size:1rem}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.btn{padding:0.75rem 1.5rem;border:none;border-radius:5px;cursor:pointer;font-size:1rem;transition:background 0.2s;margin:0.5rem 0.5rem 0.5rem 0}
.btn-primary{background:#4a90e2;color:white}
.btn-primary:hover{background:#357abd}
.btn-success{background:#28a745;color:white}
.btn-success:hover{background:#218838}
.btn-warning{background:#ffc107;color:#212529}
.btn-warning:hover{background:#e0a800}
.status-info{background:#d1ecf1;padding:1rem;border-radius:8px;margin-bottom:1rem;color:#0c5460;border:1px solid #bee5eb}
.status-info.loading{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
.status-info.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.status-info.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.current-time{background:#e8f5e8;padding:2rem;border-radius:10px;text-align:center;margin-bottom:2rem;border:1px solid #c3e6cb}
.current-time.loading{background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6}
.time-display{font-size:2rem;font-weight:bold;color:#155724;margin-bottom:0.5rem}
.time-display.loading{color:#6c757d}
.date-display{font-size:1.2rem;color:#155724}
.date-display.loading{color:#6c757d}
.server-list{background:#f8f9fa;padding:1rem;border-radius:8px;margin-top:1rem}
.debug{background:#f8f9fa;border:1px solid #dee2e6;padding:1rem;margin:1rem 0;border-radius:5px;font-family:monospace;font-size:0.8rem;max-height:300px;overflow-y:auto}
.debug-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;font-family:Arial,sans-serif}
.debug-title{font-weight:bold;color:#495057}
.debug-controls{display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap}
.debug-btn{padding:0.25rem 0.5rem;border:none;border-radius:3px;cursor:pointer;font-size:0.8rem}
.debug-btn.toggle{background:#6c757d;color:white}
.debug-btn.clear{background:#dc3545;color:white}
.debug-btn.disable{background:#28a745;color:white}
.loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid #f3f3f3;border-top:2px solid #4a90e2;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@media(max-width:768px){.container{padding:0.5rem}.form-row{grid-template-columns:1fr}.time-display{font-size:1.5rem}}
</style>
</head>
<body>
<div class="header">
<h1>üïê Configura√ß√£o NTP</h1>
<a href="config.html" class="back-btn">‚Üê Voltar</a>
</div>
<div class="container">
<div class="current-time loading">
<div class="time-display loading" id="currentTime"><span class="loading-spinner"></span>Carregando...</div>
<div class="date-display loading" id="currentDate">Aguardando dados do ESP32...</div>
</div>
<div class="config-section">
<div class="section-title">üåê Servidor NTP</div>
<div class="status-info loading" id="statusInfo">
<span class="loading-spinner"></span><strong>Status:</strong> Carregando dados do ESP32...
</div>
<div class="form-group">
<label>Servidor NTP Prim√°rio:</label>
<input type="text" id="server1" placeholder="Carregando..." disabled>
</div>
<div class="form-group">
<label>Servidor NTP Secund√°rio:</label>
<input type="text" id="server2" placeholder="Carregando..." disabled>
</div>
<div class="form-group">
<label>Servidor NTP Terci√°rio:</label>
<input type="text" id="server3" placeholder="Carregando..." disabled>
</div>
<div class="server-list">
<h4>Servidores NTP Recomendados:</h4>
<ul style="margin-top:0.5rem;padding-left:1.5rem">
<li><strong>Brasil:</strong> a.ntp.br, b.ntp.br, c.ntp.br</li>
<li><strong>Global:</strong> pool.ntp.org, time.google.com</li>
<li><strong>Cloudflare:</strong> time.cloudflare.com</li>
<li><strong>Microsoft:</strong> time.windows.com</li>
</ul>
</div>
<button class="btn btn-primary" id="saveServers" disabled>Salvar Servidores</button>
<button class="btn btn-warning" id="testConnectivity" disabled>Testar Conectividade</button>
</div>
<div class="config-section">
<div class="section-title">üåç Fuso Hor√°rio</div>
<div class="form-group">
<label>Fuso Hor√°rio:</label>
<select id="timezone" disabled>
<option value="">Carregando...</option>
<option value="-5">UTC-5 (Acre - Rio Branco)</option>
<option value="-4">UTC-4 (Amazonas - Manaus)</option>
<option value="-3">UTC-3 (Bras√≠lia - S√£o Paulo)</option>
<option value="-2">UTC-2 (Fernando de Noronha)</option>
<option value="0">UTC+0 (Greenwich)</option>
</select>
</div>
<div class="form-group">
<label>Hor√°rio de Ver√£o:</label>
<select id="dst" disabled>
<option value="">Carregando...</option>
<option value="auto">Autom√°tico</option>
<option value="enabled">Sempre Habilitado</option>
<option value="disabled">Sempre Desabilitado</option>
</select>
</div>
<button class="btn btn-primary" id="saveTimezone" disabled>Salvar Fuso</button>
</div>
<div class="config-section">
<div class="section-title">‚öôÔ∏è Configura√ß√µes Avan√ßadas</div>
<div class="form-row">
<div class="form-group">
<label>Intervalo de Sincroniza√ß√£o (min):</label>
<input type="number" id="syncInterval" placeholder="Carregando..." min="1" max="1440" disabled>
</div>
<div class="form-group">
<label>Timeout (seg):</label>
<input type="number" id="timeout" placeholder="Carregando..." min="1" max="60" disabled>
</div>
</div>
<div class="form-group">
<label>Sincroniza√ß√£o na Inicializa√ß√£o:</label>
<select id="syncOnBoot" disabled>
<option value="">Carregando...</option>
<option value="enabled">Habilitado</option>
<option value="disabled">Desabilitado</option>
</select>
</div>
<div class="form-group">
<label>Formato de Data:</label>
<select id="dateFormat" disabled>
<option value="">Carregando...</option>
<option value="dd/mm/yyyy">DD/MM/AAAA</option>
<option value="mm/dd/yyyy">MM/DD/AAAA</option>
<option value="yyyy-mm-dd">AAAA-MM-DD</option>
</select>
</div>
<div class="form-group">
<label>Formato de Hora:</label>
<select id="timeFormat" disabled>
<option value="">Carregando...</option>
<option value="24h">24 horas</option>
<option value="12h">12 horas (AM/PM)</option>
</select>
</div>
<button class="btn btn-primary" id="saveAdvanced" disabled>Salvar Configura√ß√µes</button>
<button class="btn btn-success" id="syncNow" disabled>Sincronizar Agora</button>
</div>

<!-- Debug Console NTP -->
<div id="debug" class="debug" style="display:block; margin-top: 30px;">
<div class="debug-header">
<span class="debug-title">üïê DEBUG NTP CONSOLE</span>
<div class="debug-controls">
<button class="debug-btn toggle" onclick="toggleDebugVisibility()">Minimizar</button>
<button class="debug-btn clear" onclick="clearDebug()">Limpar</button>
<button class="debug-btn disable" onclick="toggleDebugMode()">Desabilitar</button>
</div>
</div>
<div id="debugContent"></div>
</div>
</div>
<script>
// Verificar login
if(!sessionStorage.getItem('loggedIn')){
  window.location.href='login.html';
}

let ntpConfig = {};
let ntpStatus = {};
let debugMode = true;
let debugVisible = true;
let isLoading = true;

// Fun√ß√£o de debug para NTP
function debugLog(message) {
  if (debugMode) {
    console.log('üïê NTP DEBUG:', message);
    const debugDiv = document.getElementById('debugContent');
    const timestamp = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<span style="color:#6c757d">${timestamp}:</span> ${message}<br>`;
    
    if (debugVisible) {
      document.getElementById('debug').style.display = 'block';
    }
    
    debugDiv.scrollTop = debugDiv.scrollHeight;
    
    const lines = debugDiv.innerHTML.split('<br>');
    if (lines.length > 100) {
      debugDiv.innerHTML = lines.slice(-100).join('<br>');
    }
  }
}

function toggleDebugVisibility() {
  const debugDiv = document.getElementById('debug');
  const toggleBtn = document.querySelector('.debug-btn.toggle');
  
  if (debugVisible) {
    debugDiv.style.display = 'none';
    toggleBtn.textContent = 'Mostrar Debug';
    debugVisible = false;
    debugLog('Debug console minimizado');
  } else {
    debugDiv.style.display = 'block';
    toggleBtn.textContent = 'Minimizar';
    debugVisible = true;
    debugLog('Debug console restaurado');
  }
}

function clearDebug() {
  document.getElementById('debugContent').innerHTML = '';
  debugLog('Debug console limpo pelo usu√°rio');
}

function toggleDebugMode() {
  const disableBtn = document.querySelector('.debug-btn.disable');
  
  if (debugMode) {
    debugMode = false;
    disableBtn.textContent = 'Habilitar';
    disableBtn.style.background = '#dc3545';
    document.getElementById('debug').style.display = 'none';
    console.log('üïê NTP Debug mode DESABILITADO');
  } else {
    debugMode = true;
    disableBtn.textContent = 'Desabilitar';
    disableBtn.style.background = '#28a745';
    debugLog('NTP Debug mode HABILITADO novamente');
  }
}

// Habilitar interface ap√≥s carregamento
function enableInterface() {
  isLoading = false;
  
  // Habilitar todos os inputs e bot√µes
  document.querySelectorAll('input, select, button').forEach(element => {
    if (!element.classList.contains('debug-btn')) {
      element.disabled = false;
    }
  });
  
  // Remover classes de loading
  document.querySelector('.current-time').classList.remove('loading');
  document.querySelector('#currentTime').classList.remove('loading');
  document.querySelector('#currentDate').classList.remove('loading');
  
  debugLog('‚úÖ Interface NTP habilitada - dados carregados do ESP32');
}

// Atualizar display de tempo do ESP32
function updateTime() {
  debugLog('üîÑ Solicitando status NTP do ESP32...');
  
  fetch('/api/ntp/status')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      ntpStatus = data;
      debugLog(`üì° Status recebido: ${data.synchronized ? 'Sincronizado' : 'N√£o sincronizado'} | Timestamp: ${data.timestamp} | Uptime: ${Math.floor(data.uptime/60)}min`);
      
      if (data.synchronized && data.currentTime) {
        // Usar tempo do ESP32 se sincronizado
        const serverTime = new Date(data.currentTime);
        const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
        const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
        
        document.getElementById('currentTime').textContent = serverTime.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('currentDate').textContent = serverTime.toLocaleDateString('pt-BR', dateOptions);
        
        // Atualizar status
        const statusDiv = document.getElementById('statusInfo');
        statusDiv.innerHTML = `‚úÖ <strong>Status:</strong> Sincronizado | √öltima sincroniza√ß√£o: ${data.lastSync} | Uptime: ${Math.floor(data.uptime/60)}min`;
        statusDiv.className = 'status-info success';
        
        debugLog(`‚úÖ Tempo sincronizado exibido: ${serverTime.toLocaleString('pt-BR')}`);
      } else {
        // Usar timestamp do ESP32 mesmo se n√£o sincronizado
        let displayTime;
        if (data.timestamp && data.timestamp > 1000000000) {
          displayTime = new Date(data.timestamp * 1000);
          debugLog(`‚ö†Ô∏è NTP n√£o sincronizado, usando timestamp ESP32: ${data.timestamp}`);
        } else {
          displayTime = new Date();
          debugLog(`‚ö†Ô∏è Timestamp inv√°lido, usando tempo local do navegador`);
        }
        
        const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
        const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
        
        document.getElementById('currentTime').textContent = displayTime.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('currentDate').textContent = displayTime.toLocaleDateString('pt-BR', dateOptions);
        
        const statusDiv = document.getElementById('statusInfo');
        statusDiv.innerHTML = `‚ö†Ô∏è <strong>Status:</strong> N√£o sincronizado | Aguardando conex√£o NTP | Uptime: ${Math.floor(data.uptime/60)}min`;
        statusDiv.className = 'status-info';
      }
      
      // Habilitar interface na primeira carga bem-sucedida
      if (isLoading) {
        enableInterface();
      }
    })
    .catch(error => {
      console.error('Erro ao obter status NTP:', error);
      debugLog(`‚ùå Erro ao obter status NTP: ${error.message}`);
      
      const statusDiv = document.getElementById('statusInfo');
      statusDiv.innerHTML = `‚ùå <strong>Status:</strong> Erro de comunica√ß√£o com ESP32: ${error.message}`;
      statusDiv.className = 'status-info error';
      
      // Fallback para tempo local
      const now = new Date();
      const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
      const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
      
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', timeOptions);
      document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', dateOptions);
      
      debugLog(`üîÑ Fallback para tempo local ativado: ${now.toLocaleString('pt-BR')}`);
    });
}

// Carregar configura√ß√µes NTP
async function loadNtpConfig() {
  debugLog('üîÑ Carregando configura√ß√µes NTP do ESP32...');
  
  try {
    const response = await fetch('/api/ntp/config');
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    ntpConfig = data;
    
    debugLog(`üì• Configura√ß√µes recebidas: Servidor1="${data.server1}" | Servidor2="${data.server2}" | Servidor3="${data.server3}" | Intervalo=${Math.floor((data.syncInterval || 3600) / 60)}min`);
    
    // Preencher campos com configura√ß√µes reais
    document.getElementById('server1').value = data.server1 || 'pool.ntp.org';
    document.getElementById('server2').value = data.server2 || 'time.google.com';
    document.getElementById('server3').value = data.server3 || 'time.cloudflare.com';
    
    // Preencher outros campos
    document.getElementById('syncInterval').value = Math.floor((data.syncInterval || 3600) / 60);
    document.getElementById('timeout').value = data.timeout || 10;
    
    // Configurar selects com valores padr√£o
    document.getElementById('timezone').value = '-3';
    document.getElementById('dst').value = 'disabled';
    document.getElementById('syncOnBoot').value = 'enabled';
    document.getElementById('dateFormat').value = 'dd/mm/yyyy';
    document.getElementById('timeFormat').value = '24h';
    
    console.log('‚úÖ Configura√ß√µes NTP carregadas:', data);
    debugLog('‚úÖ Campos da interface preenchidos com dados do ESP32');
  } catch (error) {
    console.error('‚ùå Erro ao carregar configura√ß√µes NTP:', error);
    debugLog(`‚ùå Erro ao carregar configura√ß√µes: ${error.message}`);
    showMessage('Erro ao carregar configura√ß√µes NTP: ' + error.message, 'error');
    
    // Valores padr√£o em caso de erro
    document.getElementById('server1').value = 'pool.ntp.org';
    document.getElementById('server2').value = 'time.google.com';
    document.getElementById('server3').value = 'time.cloudflare.com';
    document.getElementById('syncInterval').value = 60;
    document.getElementById('timeout').value = 10;
    document.getElementById('timezone').value = '-3';
    document.getElementById('dst').value = 'disabled';
    document.getElementById('syncOnBoot').value = 'enabled';
    document.getElementById('dateFormat').value = 'dd/mm/yyyy';
    document.getElementById('timeFormat').value = '24h';
  }
}

// Salvar configura√ß√µes NTP
async function saveNtpConfig() {
  debugLog('üíæ Preparando salvamento das configura√ß√µes NTP...');
  
  try {
    const server1 = document.getElementById('server1').value;
    const server2 = document.getElementById('server2').value;
    const server3 = document.getElementById('server3').value;
    const syncInterval = parseInt(document.getElementById('syncInterval').value) * 60;
    
    const config = {
      enabled: true,
      server1: server1,
      server2: server2,
      server3: server3,
      timezone: "America/Sao_Paulo",
      syncInterval: syncInterval
    };
    
    debugLog(`üì§ Enviando configura√ß√µes: Servidor1="${server1}" | Servidor2="${server2}" | Servidor3="${server3}" | Intervalo=${syncInterval/60}min`);
    
    const response = await fetch('/api/ntp/config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(config)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      showMessage('Configura√ß√µes NTP salvas com sucesso!', 'success');
      console.log('‚úÖ Configura√ß√µes NTP salvas');
      debugLog('‚úÖ Configura√ß√µes NTP salvas no ESP32 com sucesso');
    } else {
      showMessage('Erro ao salvar configura√ß√µes: ' + (result.error || 'Erro desconhecido'), 'error');
      debugLog(`‚ùå Erro retornado pelo ESP32: ${result.error || 'Erro desconhecido'}`);
    }
  } catch (error) {
    console.error('‚ùå Erro ao salvar configura√ß√µes NTP:', error);
    debugLog(`‚ùå Erro de comunica√ß√£o ao salvar: ${error.message}`);
    showMessage('Erro ao salvar configura√ß√µes NTP: ' + error.message, 'error');
  }
}

// For√ßar sincroniza√ß√£o NTP
async function syncNow() {
  debugLog('üîÑ Iniciando sincroniza√ß√£o NTP manual...');
  
  try {
    showMessage('Iniciando sincroniza√ß√£o NTP...', 'loading');
    
    const response = await fetch('/api/ntp/sync', {
      method: 'POST'
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      showMessage('Sincroniza√ß√£o NTP iniciada!', 'success');
      debugLog('‚úÖ Comando de sincroniza√ß√£o manual enviado ao ESP32');
      setTimeout(() => {
        debugLog('‚è±Ô∏è Atualizando status ap√≥s sincroniza√ß√£o manual...');
        updateTime();
      }, 2000);
    } else {
      showMessage('Erro na sincroniza√ß√£o: ' + (result.error || 'Erro desconhecido'), 'error');
      debugLog(`‚ùå Erro na sincroniza√ß√£o manual: ${result.error || 'Erro desconhecido'}`);
    }
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o NTP:', error);
    debugLog(`‚ùå Erro de comunica√ß√£o na sincroniza√ß√£o: ${error.message}`);
    showMessage('Erro na sincroniza√ß√£o NTP: ' + error.message, 'error');
  }
}

// Fun√ß√£o para mostrar mensagens
function showMessage(message, type = 'info') {
  const statusDiv = document.getElementById('statusInfo');
  const originalContent = statusDiv.innerHTML;
  const originalClass = statusDiv.className;
  
  const icon = type === 'success' ? '‚úÖ' : 
               type === 'error' ? '‚ùå' : 
               type === 'loading' ? '<span class="loading-spinner"></span>' : '‚ÑπÔ∏è';
  
  statusDiv.innerHTML = `${icon} <strong>Status:</strong> ${message}`;
  statusDiv.className = `status-info ${type}`;
  
  // Restaurar ap√≥s 3 segundos (exceto para loading)
  if (type !== 'loading') {
    setTimeout(() => {
      statusDiv.innerHTML = originalContent;
      statusDiv.className = originalClass;
    }, 3000);
  }
}

// Testar conectividade
async function testConnectivity() {
  debugLog('üîß Testando conectividade com servidores NTP...');
  showMessage('Testando conectividade NTP...', 'loading');
  
  try {
    // Simular teste for√ßando uma sincroniza√ß√£o
    const response = await fetch('/api/ntp/sync', {
      method: 'POST'
    });
    
    if (response.ok) {
      showMessage('Teste de conectividade conclu√≠do - verifique logs do ESP32', 'success');
      debugLog('‚úÖ Teste de conectividade iniciado');
    } else {
      throw new Error(`HTTP ${response.status}`);
    }
  } catch (error) {
    showMessage('Erro no teste de conectividade: ' + error.message, 'error');
    debugLog(`‚ùå Erro no teste: ${error.message}`);
  }
}

// Event listeners para bot√µes
document.addEventListener('DOMContentLoaded', () => {
  debugLog('üöÄ P√°gina NTP carregada - Inicializando interface...');
  
  // Bot√£o Salvar Servidores
  document.getElementById('saveServers').onclick = saveNtpConfig;
  
  // Bot√£o Sincronizar Agora
  document.getElementById('syncNow').onclick = syncNow;
  
  // Bot√£o Salvar Fuso
  document.getElementById('saveTimezone').onclick = saveNtpConfig;
  
  // Bot√£o Salvar Configura√ß√µes Avan√ßadas
  document.getElementById('saveAdvanced').onclick = saveNtpConfig;
  
  // Bot√£o Testar Conectividade
  document.getElementById('testConnectivity').onclick = testConnectivity;
  
  // Carregar configura√ß√µes iniciais
  loadNtpConfig();
  
  debugLog('‚úÖ Event listeners configurados - Interface NTP pronta');
});

// Inicializar
debugLog('üïê Sistema de debug NTP ativado - Carregando dados reais do ESP32...');
updateTime();
setInterval(() => {
  if (!isLoading) {
    debugLog('‚è∞ Atualiza√ß√£o autom√°tica de status (intervalo 10s)');
    updateTime();
  }
}, 10000); // Atualizar a cada 10 segundos
</script>
</body>
</html> 