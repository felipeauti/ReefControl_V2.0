<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReefControl - Sensores</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f7fa;min-height:100vh}
.header{background:#4a90e2;color:white;padding:1rem;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:1.5rem}
.back-btn{background:rgba(255,255,255,0.2);border:none;color:white;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:0.5rem}
.container{padding:1rem;max-width:1000px;margin:0 auto}
.sensor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem}
.sensor-card{background:white;padding:1.5rem;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.sensor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.sensor-title{font-weight:bold;font-size:1.1rem;display:flex;align-items:center;gap:0.5rem}
.sensor-value{font-size:1.2rem;font-weight:bold;color:#4a90e2}
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:bold;color:#555}
.form-group input,.form-group select{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;font-size:0.9rem}
.calibration-section{background:#f8f9fa;padding:1rem;border-radius:8px;margin-top:1rem}
.calibration-title{font-weight:bold;margin-bottom:1rem;color:#333}
.btn{padding:0.5rem 1rem;border:none;border-radius:5px;cursor:pointer;font-size:0.9rem;transition:background 0.2s;margin:0.25rem}
.btn-primary{background:#4a90e2;color:white}
.btn-primary:hover{background:#357abd}
.btn-success{background:#28a745;color:white}
.btn-success:hover{background:#218838}
.btn-warning{background:#ffc107;color:#212529}
.btn-warning:hover{background:#e0a800}
.status-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-left:0.5rem}
.online{background:#28a745}
.offline{background:#dc3545}
.warning{background:#ffc107}
@media(max-width:768px){.container{padding:0.5rem}.sensor-grid{grid-template-columns:1fr}}

/* Estilos adicionais para lista de sensores */
.sensor-list {
    margin-top: 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.sensor-item {
    padding: 1rem;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
}

.sensor-item:last-child {
    border-bottom: none;
}

.sensor-info {
    flex: 1;
}

.sensor-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.sensor-address {
    font-size: 0.8rem;
    color: #666;
    font-family: monospace;
}

.sensor-temp {
    font-weight: bold;
    color: #4a90e2;
    margin-left: 1rem;
}

.sensor-actions {
    display: flex;
    gap: 0.5rem;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-title {
    font-size: 1.2rem;
    font-weight: bold;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}
</style>
</head>
<body>
<div class="header">
<h1>üìä Configura√ß√£o de Sensores</h1>
<a href="config.html" class="back-btn">‚Üê Voltar</a>
</div>
<div class="container">
<div class="sensor-grid">
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üå°Ô∏è Temperatura
<span class="status-indicator online"></span>
</div>
<div class="sensor-value" id="currentTemp">24.5¬∞C</div>
</div>

<div class="form-group">
<label>Tipo de Sensor:</label>
<select id="sensorType" disabled>
<option value="ds18b20" selected>DS18B20 (OneWire)</option>
</select>
</div>

<div class="form-group">
<label>Pino:</label>
<select id="sensorPin" disabled>
<option value="4" selected>GPIO 4 (OneWire)</option>
</select>
</div>

<!-- Lista de Sensores -->
<div id="sensorList" class="sensor-list">
<!-- Sensores ser√£o adicionados aqui via JavaScript -->
</div>

<button class="btn btn-primary" onclick="showAddSensorModal()" style="margin-top: 1rem;">
Adicionar Sensor
</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üß™ pH
<span class="status-indicator online"></span>
</div>
<div class="sensor-value">7.8</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="analog" selected>pH Anal√≥gico</option>
<option value="atlas">Atlas Scientific</option>
</select>
</div>
<div class="form-group">
<label>Pino:</label>
<select>
<option value="A0" selected>A0 (Anal√≥gico)</option>
</select>
</div>
<div class="form-group">
<label>Corre√ß√£o:</label>
<input type="number" step="0.01" value="0.00">
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Valor atual: <strong>7.80</strong></p>
<div class="form-group">
<label>pH real (solu√ß√£o de refer√™ncia):</label>
<input type="number" step="0.01" placeholder="7.00">
</div>
<button class="btn btn-warning">Calibrar pH 7.0</button>
<button class="btn btn-warning">Calibrar pH 4.0</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üíß TDS/EC
<span class="status-indicator warning"></span>
</div>
<div class="sensor-value">380 ppm</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="tds_meter" selected>TDS Meter</option>
<option value="ec_probe">EC Probe</option>
</select>
</div>
<div class="form-group">
<label>Pino:</label>
<select>
<option value="A0" selected>A0 (Anal√≥gico)</option>
</select>
</div>
<div class="form-group">
<label>Fator de Convers√£o:</label>
<input type="number" step="0.1" value="0.5">
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Valor atual: <strong>380 ppm</strong></p>
<div class="form-group">
<label>Valor real (solu√ß√£o calibrada):</label>
<input type="number" placeholder="400">
</div>
<button class="btn btn-warning">Calibrar</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üìè N√≠vel da √Ågua
<span class="status-indicator online"></span>
</div>
<div class="sensor-value">85%</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="ultrasonic" selected>HC-SR04</option>
<option value="float">Sensor de Boia</option>
<option value="pressure">Sensor de Press√£o</option>
</select>
</div>
<div class="form-group">
<label>Pino Trigger:</label>
<select>
<option value="12" selected>GPIO 12 (D6)</option>
<option value="13">GPIO 13 (D7)</option>
</select>
</div>
<div class="form-group">
<label>Pino Echo:</label>
<select>
<option value="13" selected>GPIO 13 (D7)</option>
<option value="14">GPIO 14 (D5)</option>
</select>
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Dist√¢ncia atual: <strong>15 cm</strong></p>
<div class="form-group">
<label>Altura m√°xima (cm):</label>
<input type="number" value="50">
</div>
<div class="form-group">
<label>Altura m√≠nima (cm):</label>
<input type="number" value="5">
</div>
<button class="btn btn-warning">Calibrar Vazio</button>
<button class="btn btn-warning">Calibrar Cheio</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
</div>
</div>
</div>

<!-- Modal para Adicionar Sensor -->
<div id="addSensorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Adicionar Sensor DS18B20</div>
            <button class="close-modal" onclick="hideAddSensorModal()">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Endere√ßo OneWire:</label>
            <select id="availableAddresses" style="margin-bottom: 0.5rem;">
                <option value="" disabled selected>Selecione um endere√ßo</option>
            </select>
            <button class="btn btn-primary" onclick="scanOneWire()" style="width: 100%;">
                Buscar Sensores
            </button>
        </div>

        <div class="form-group">
            <label>Nome do Sensor:</label>
            <input type="text" id="sensorName" placeholder="Ex: Aqu√°rio Principal">
        </div>

        <button class="btn btn-success" onclick="addSensor()" style="width: 100%;">
            Adicionar Sensor
        </button>
    </div>
</div>

<!-- Modal para Calibra√ß√£o -->
<div id="calibrationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Calibrar Sensor</div>
            <button class="close-modal" onclick="hideCalibrationModal()">&times;</button>
        </div>
        
        <div id="calibrationContent">
            <!-- Conte√∫do ser√° preenchido via JavaScript -->
        </div>
    </div>
</div>

<script>
if(!sessionStorage.getItem('loggedIn')){
    window.location.href='login.html';
}

// Vari√°veis globais
let selectedAddress = '';
let sensors = [];

// Fun√ß√µes auxiliares
function showAddSensorModal() {
    document.getElementById('addSensorModal').style.display = 'flex';
    scanOneWire();
}

function hideAddSensorModal() {
    document.getElementById('addSensorModal').style.display = 'none';
}

function showCalibrationModal(address) {
    const sensor = sensors.find(s => s.address === address);
    if (!sensor) return;

    const content = document.getElementById('calibrationContent');
    content.innerHTML = `
        <p>Sensor: <strong>${sensor.name}</strong></p>
        <p>Endere√ßo: <code>${sensor.address}</code></p>
        <p>Temperatura atual: <strong>${sensor.temperature.toFixed(2)}¬∞C</strong></p>
        <p>Offset atual: <strong>${sensor.offset.toFixed(2)}¬∞C</strong></p>
        
        <div class="form-group">
            <label>Temperatura real:</label>
            <input type="number" step="0.1" id="realTemp" placeholder="25.0">
        </div>

        <button class="btn btn-warning" onclick="calibrateSensor('${address}')" style="width: 100%; margin-bottom: 0.5rem;">
            Calibrar
        </button>
        <button class="btn btn-warning" onclick="resetCalibration('${address}')" style="width: 100%;">
            Resetar Calibra√ß√£o
        </button>
    `;

    document.getElementById('calibrationModal').style.display = 'flex';
}

function hideCalibrationModal() {
    document.getElementById('calibrationModal').style.display = 'none';
}

// Fun√ß√µes de API
async function scanOneWire() {
    try {
        const response = await fetch('/api/onewire/scan');
        const data = await response.json();
        
        const select = document.getElementById('availableAddresses');
        select.innerHTML = '<option value="" disabled selected>Selecione um endere√ßo</option>';
        
        data.forEach(device => {
            if (!device.inUse) {
                const option = document.createElement('option');
                option.value = device.address;
                option.textContent = device.address;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Erro ao buscar sensores:', error);
    }
}

async function loadSensors() {
    try {
        const response = await fetch('/api/ds18b20/sensors');
        sensors = await response.json();
        updateSensorList();
    } catch (error) {
        console.error('Erro ao carregar sensores:', error);
    }
}

async function addSensor() {
    const address = document.getElementById('availableAddresses').value;
    const name = document.getElementById('sensorName').value;

    if (!address || !name) {
        alert('Por favor, selecione um endere√ßo e digite um nome para o sensor.');
        return;
    }

    try {
        const response = await fetch('/api/ds18b20/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address, name })
        });

        const result = await response.json();
        if (result.success) {
            hideAddSensorModal();
            loadSensors();
        } else {
            alert('Erro ao adicionar sensor.');
        }
    } catch (error) {
        console.error('Erro ao adicionar sensor:', error);
    }
}

async function removeSensor(address) {
    if (!confirm('Tem certeza que deseja remover este sensor?')) return;

    try {
        const response = await fetch('/api/ds18b20/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address })
        });

        const result = await response.json();
        if (result.success) {
            loadSensors();
        } else {
            alert('Erro ao remover sensor.');
        }
    } catch (error) {
        console.error('Erro ao remover sensor:', error);
    }
}

async function calibrateSensor(address) {
    const realTemp = parseFloat(document.getElementById('realTemp').value);
    if (isNaN(realTemp)) {
        alert('Por favor, digite uma temperatura v√°lida.');
        return;
    }

    try {
        const response = await fetch('/api/ds18b20/calibrate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address, temperature: realTemp })
        });

        const result = await response.json();
        if (result.success) {
            hideCalibrationModal();
            loadSensors();
        } else {
            alert('Erro ao calibrar sensor.');
        }
    } catch (error) {
        console.error('Erro ao calibrar sensor:', error);
    }
}

async function resetCalibration(address) {
    try {
        const response = await fetch('/api/ds18b20/reset-calibration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address })
        });

        const result = await response.json();
        if (result.success) {
            hideCalibrationModal();
            loadSensors();
        } else {
            alert('Erro ao resetar calibra√ß√£o.');
        }
    } catch (error) {
        console.error('Erro ao resetar calibra√ß√£o:', error);
    }
}

function updateSensorList() {
    const list = document.getElementById('sensorList');
    list.innerHTML = '';

    sensors.forEach(sensor => {
        const item = document.createElement('div');
        item.className = 'sensor-item';
        item.innerHTML = `
            <div class="sensor-info">
                <div class="sensor-name">${sensor.name}</div>
                <div class="sensor-address">${sensor.address}</div>
            </div>
            <div class="sensor-temp">${sensor.temperature.toFixed(2)}¬∞C</div>
            <div class="sensor-actions">
                <button class="btn btn-warning" onclick="showCalibrationModal('${sensor.address}')">
                    Calibrar
                </button>
                <button class="btn btn-danger" onclick="removeSensor('${sensor.address}')">
                    Remover
                </button>
            </div>
        `;
        list.appendChild(item);
    });
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    loadSensors();
});

// Atualiza√ß√£o autom√°tica a cada 5 segundos
setInterval(loadSensors, 5000);
</script>
</body>
</html> 