<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReefControl - Sensores</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f7fa;min-height:100vh}
.header{background:#4a90e2;color:white;padding:1rem;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:1.5rem}
.back-btn{background:rgba(255,255,255,0.2);border:none;color:white;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:0.5rem}
.container{padding:1rem;max-width:1000px;margin:0 auto}
.sensor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem}
.sensor-card{background:white;padding:1.5rem;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.sensor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.sensor-title{font-weight:bold;font-size:1.1rem;display:flex;align-items:center;gap:0.5rem}
.sensor-value{font-size:1.2rem;font-weight:bold;color:#4a90e2}
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:bold;color:#555}
.form-group input,.form-group select{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;font-size:0.9rem}
.calibration-section{background:#f8f9fa;padding:1rem;border-radius:8px;margin-top:1rem}
.calibration-title{font-weight:bold;margin-bottom:1rem;color:#333}
.btn{padding:0.5rem 1rem;border:none;border-radius:5px;cursor:pointer;font-size:0.9rem;transition:background 0.2s;margin:0.25rem}
.btn-primary{background:#4a90e2;color:white}
.btn-primary:hover{background:#357abd}
.btn-success{background:#28a745;color:white}
.btn-success:hover{background:#218838}
.btn-warning{background:#ffc107;color:#212529}
.btn-warning:hover{background:#e0a800}
.status-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-left:0.5rem}
.online{background:#28a745}
.offline{background:#dc3545}
.warning{background:#ffc107}
@media(max-width:768px){.container{padding:0.5rem}.sensor-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="header">
<h1>üìä Configura√ß√£o de Sensores</h1>
<a href="config.html" class="back-btn">‚Üê Voltar</a>
</div>
<div class="container">
<div class="sensor-grid">
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üå°Ô∏è Temperatura
<span class="status-indicator online"></span>
</div>
<div class="sensor-value" id="currentTemp">24.5¬∞C</div>
</div>

<div class="form-group">
<label>Tipo de Sensor:</label>
<select id="sensorType" onchange="handleSensorTypeChange()">
<option value="ds18b20" selected>DS18B20 (OneWire)</option>
<option value="dht11">DHT11</option>
<option value="dht22">DHT22</option>
</select>
</div>

<div class="form-group" id="oneWireAddressGroup" style="display: none;">
<label>Endere√ßo OneWire:</label>
<div style="display: flex; gap: 0.5rem;">
<input type="text" id="oneWireAddress" readonly placeholder="Buscando endere√ßos..." style="flex: 1;">
<button class="btn btn-primary" onclick="scanOneWire()">Buscar</button>
</div>
<small style="display: block; margin-top: 0.5rem; color: #666;">Clique em "Buscar" para detectar sensores DS18B20 conectados</small>
</div>

<div class="form-group">
<label>Pino:</label>
<select id="sensorPin">
<option value="" disabled selected>Selecione o pino</option>
</select>
</div>

<div class="form-group">
<label>Corre√ß√£o (¬∞C):</label>
<input type="number" step="0.1" value="0.0" id="tempOffset" readonly>
</div>

<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Valor atual: <strong id="currentTemp">24.5¬∞C</strong></p>
<div class="form-group">
<label>Temperatura real:</label>
<input type="number" step="0.1" placeholder="25.0" id="realTemp">
</div>
<button class="btn btn-warning" onclick="calibrateTemperature()">Calibrar</button>
<button class="btn btn-warning" onclick="resetCalibration()">Resetar Calibra√ß√£o</button>
</div>

<button class="btn btn-primary">Salvar</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üß™ pH
<span class="status-indicator online"></span>
</div>
<div class="sensor-value">7.8</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="analog" selected>pH Anal√≥gico</option>
<option value="atlas">Atlas Scientific</option>
</select>
</div>
<div class="form-group">
<label>Pino:</label>
<select>
<option value="A0" selected>A0 (Anal√≥gico)</option>
</select>
</div>
<div class="form-group">
<label>Corre√ß√£o:</label>
<input type="number" step="0.01" value="0.00">
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Valor atual: <strong>7.80</strong></p>
<div class="form-group">
<label>pH real (solu√ß√£o de refer√™ncia):</label>
<input type="number" step="0.01" placeholder="7.00">
</div>
<button class="btn btn-warning">Calibrar pH 7.0</button>
<button class="btn btn-warning">Calibrar pH 4.0</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üíß TDS/EC
<span class="status-indicator warning"></span>
</div>
<div class="sensor-value">380 ppm</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="tds_meter" selected>TDS Meter</option>
<option value="ec_probe">EC Probe</option>
</select>
</div>
<div class="form-group">
<label>Pino:</label>
<select>
<option value="A0" selected>A0 (Anal√≥gico)</option>
</select>
</div>
<div class="form-group">
<label>Fator de Convers√£o:</label>
<input type="number" step="0.1" value="0.5">
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Valor atual: <strong>380 ppm</strong></p>
<div class="form-group">
<label>Valor real (solu√ß√£o calibrada):</label>
<input type="number" placeholder="400">
</div>
<button class="btn btn-warning">Calibrar</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
<div class="sensor-card">
<div class="sensor-header">
<div class="sensor-title">
üìè N√≠vel da √Ågua
<span class="status-indicator online"></span>
</div>
<div class="sensor-value">85%</div>
</div>
<div class="form-group">
<label>Tipo de Sensor:</label>
<select>
<option value="ultrasonic" selected>HC-SR04</option>
<option value="float">Sensor de Boia</option>
<option value="pressure">Sensor de Press√£o</option>
</select>
</div>
<div class="form-group">
<label>Pino Trigger:</label>
<select>
<option value="12" selected>GPIO 12 (D6)</option>
<option value="13">GPIO 13 (D7)</option>
</select>
</div>
<div class="form-group">
<label>Pino Echo:</label>
<select>
<option value="13" selected>GPIO 13 (D7)</option>
<option value="14">GPIO 14 (D5)</option>
</select>
</div>
<div class="calibration-section">
<div class="calibration-title">Calibra√ß√£o</div>
<p>Dist√¢ncia atual: <strong>15 cm</strong></p>
<div class="form-group">
<label>Altura m√°xima (cm):</label>
<input type="number" value="50">
</div>
<div class="form-group">
<label>Altura m√≠nima (cm):</label>
<input type="number" value="5">
</div>
<button class="btn btn-warning">Calibrar Vazio</button>
<button class="btn btn-warning">Calibrar Cheio</button>
</div>
<button class="btn btn-primary">Salvar</button>
</div>
</div>
</div>
</div>
<script>
if(!sessionStorage.getItem('loggedIn')){
    window.location.href='login.html';
}

// Fun√ß√µes para gerenciar sensores
function handleSensorTypeChange() {
    const sensorType = document.getElementById('sensorType').value;
    const oneWireGroup = document.getElementById('oneWireAddressGroup');
    
    // Mostrar/ocultar grupo de endere√ßo OneWire
    oneWireGroup.style.display = sensorType === 'ds18b20' ? 'block' : 'none';
    
    // Atualizar lista de pinos dispon√≠veis
    updateAvailablePins(sensorType);
}

function updateAvailablePins(sensorType) {
    // Buscar pinos dispon√≠veis via API
    fetch('/api/sensors/available_pins?type=' + sensorType)
        .then(response => response.json())
        .then(data => {
            const pinSelect = document.getElementById('sensorPin');
            pinSelect.innerHTML = '<option value="" disabled selected>Selecione o pino</option>';
            
            data.pins.forEach(pin => {
                const option = document.createElement('option');
                option.value = pin.number;
                option.textContent = pin.label;
                pinSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Erro ao buscar pinos:', error));
}

function scanOneWire() {
    const addressInput = document.getElementById('oneWireAddress');
    const scanButton = document.querySelector('#oneWireAddressGroup button');
    
    // Desabilitar bot√£o durante a busca
    scanButton.disabled = true;
    scanButton.textContent = 'Buscando...';
    addressInput.value = 'Procurando sensores...';
    
    // Chamar API para buscar endere√ßos
    fetch('/api/sensors/scan_onewire')
        .then(response => response.json())
        .then(data => {
            if (data.addresses && data.addresses.length > 0) {
                addressInput.value = data.addresses[0]; // Por enquanto pegamos s√≥ o primeiro
            } else {
                addressInput.value = 'Nenhum sensor encontrado';
            }
        })
        .catch(error => {
            console.error('Erro ao buscar sensores:', error);
            addressInput.value = 'Erro ao buscar sensores';
        })
        .finally(() => {
            scanButton.disabled = false;
            scanButton.textContent = 'Buscar';
        });
}

// Fun√ß√£o para calibrar temperatura
function calibrateTemperature() {
    const measuredTemp = parseFloat(document.getElementById('realTemp').value);
    if (isNaN(measuredTemp)) {
        alert('Por favor, digite uma temperatura v√°lida');
        return;
    }
    
    fetch('/api/sensors/calibrate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ measuredTemp: measuredTemp })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Calibra√ß√£o realizada com sucesso!');
            location.reload(); // Recarrega para mostrar novos valores
        } else {
            alert('Erro na calibra√ß√£o: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao calibrar:', error);
        alert('Erro ao calibrar temperatura');
    });
}

// Fun√ß√£o para resetar calibra√ß√£o
function resetCalibration() {
    if (!confirm('Tem certeza que deseja resetar a calibra√ß√£o?')) return;
    
    fetch('/api/sensors/calibrate/reset', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Calibra√ß√£o resetada com sucesso!');
            location.reload(); // Recarrega para mostrar novos valores
        } else {
            alert('Erro ao resetar calibra√ß√£o: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao resetar:', error);
        alert('Erro ao resetar calibra√ß√£o');
    });
}

// Atualizar valores em tempo real
function updateSensorValues() {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(data => {
            document.getElementById('currentTemp').textContent = data.temp.toFixed(1) + '¬∞C';
            document.getElementById('tempOffset').value = data.tempOffset.toFixed(1);
        })
        .catch(error => console.error('Erro ao atualizar valores:', error));
}

// Atualizar valores a cada 5 segundos
setInterval(updateSensorValues, 5000);

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    handleSensorTypeChange(); // Configurar visibilidade inicial
    updateSensorValues(); // Buscar valores iniciais
});
</script>
</body>
</html> 