<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ReefControl - Servidor NTP</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f7fa;min-height:100vh}
.header{background:#4a90e2;color:white;padding:1rem;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:1.5rem}
.back-btn{background:rgba(255,255,255,0.2);border:none;color:white;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:0.5rem}
.container{padding:1rem;max-width:800px;margin:0 auto}
.config-section{background:white;padding:2rem;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:2rem}
.section-title{font-weight:bold;font-size:1.2rem;margin-bottom:1.5rem;color:#333;border-bottom:2px solid #4a90e2;padding-bottom:0.5rem}
.form-group{margin-bottom:1.5rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:bold;color:#555}
.form-group input,.form-group select{width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:5px;font-size:1rem}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.btn{padding:0.75rem 1.5rem;border:none;border-radius:5px;cursor:pointer;font-size:1rem;transition:background 0.2s;margin:0.5rem 0.5rem 0.5rem 0}
.btn-primary{background:#4a90e2;color:white}
.btn-primary:hover{background:#357abd}
.btn-success{background:#28a745;color:white}
.btn-success:hover{background:#218838}
.btn-warning{background:#ffc107;color:#212529}
.btn-warning:hover{background:#e0a800}
.status-info{background:#d1ecf1;padding:1rem;border-radius:8px;margin-bottom:1rem;color:#0c5460;border:1px solid #bee5eb}
.current-time{background:#e8f5e8;padding:2rem;border-radius:10px;text-align:center;margin-bottom:2rem;border:1px solid #c3e6cb}
.time-display{font-size:2rem;font-weight:bold;color:#155724;margin-bottom:0.5rem}
.date-display{font-size:1.2rem;color:#155724}
.server-list{background:#f8f9fa;padding:1rem;border-radius:8px;margin-top:1rem}
.debug{background:#f8f9fa;border:1px solid #dee2e6;padding:1rem;margin:1rem 0;border-radius:5px;font-family:monospace;font-size:0.8rem;max-height:300px;overflow-y:auto}
.debug-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;font-family:Arial,sans-serif}
.debug-title{font-weight:bold;color:#495057}
.debug-controls{display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap}
.debug-btn{padding:0.25rem 0.5rem;border:none;border-radius:3px;cursor:pointer;font-size:0.8rem}
.debug-btn.toggle{background:#6c757d;color:white}
.debug-btn.clear{background:#dc3545;color:white}
.debug-btn.disable{background:#28a745;color:white}
@media(max-width:768px){.container{padding:0.5rem}.form-row{grid-template-columns:1fr}.time-display{font-size:1.5rem}}
</style>
</head>
<body>
<div class="header">
<h1>üïê Configura√ß√£o NTP</h1>
<a href="config.html" class="back-btn">‚Üê Voltar</a>
</div>
<div class="container">
<div class="current-time">
<div class="time-display" id="currentTime">14:30:25</div>
<div class="date-display" id="currentDate">Domingo, 15 de Dezembro de 2024</div>
</div>
<div class="config-section">
<div class="section-title">üåê Servidor NTP</div>
<div class="status-info">
‚úÖ <strong>Status:</strong> Sincronizado | √öltima sincroniza√ß√£o: h√° 2 minutos
</div>
<div class="form-group">
<label>Servidor NTP Prim√°rio:</label>
<input type="text" value="pool.ntp.org" placeholder="pool.ntp.org">
</div>
<div class="form-group">
<label>Servidor NTP Secund√°rio:</label>
<input type="text" value="time.google.com" placeholder="time.google.com">
</div>
<div class="form-group">
<label>Servidor NTP Terci√°rio:</label>
<input type="text" value="time.cloudflare.com" placeholder="time.cloudflare.com">
</div>
<div class="server-list">
<h4>Servidores NTP Recomendados:</h4>
<ul style="margin-top:0.5rem;padding-left:1.5rem">
<li><strong>Brasil:</strong> a.ntp.br, b.ntp.br, c.ntp.br</li>
<li><strong>Global:</strong> pool.ntp.org, time.google.com</li>
<li><strong>Cloudflare:</strong> time.cloudflare.com</li>
<li><strong>Microsoft:</strong> time.windows.com</li>
</ul>
</div>
<button class="btn btn-primary" id="saveServers">Salvar Servidores</button>
<button class="btn btn-warning" id="testConnectivity">Testar Conectividade</button>
</div>
<div class="config-section">
<div class="section-title">üåç Fuso Hor√°rio</div>
<div class="form-group">
<label>Fuso Hor√°rio:</label>
<select>
<option value="-5">UTC-5 (Acre - Rio Branco)</option>
<option value="-4">UTC-4 (Amazonas - Manaus)</option>
<option value="-3" selected>UTC-3 (Bras√≠lia - S√£o Paulo)</option>
<option value="-2">UTC-2 (Fernando de Noronha)</option>
<option value="0">UTC+0 (Greenwich)</option>
</select>
</div>
<div class="form-group">
<label>Hor√°rio de Ver√£o:</label>
<select>
<option value="auto">Autom√°tico</option>
<option value="enabled">Sempre Habilitado</option>
<option value="disabled" selected>Sempre Desabilitado</option>
</select>
</div>
<button class="btn btn-primary" id="saveTimezone">Salvar Fuso</button>
</div>
<div class="config-section">
<div class="section-title">‚öôÔ∏è Configura√ß√µes Avan√ßadas</div>
<div class="form-row">
<div class="form-group">
<label>Intervalo de Sincroniza√ß√£o (min):</label>
<input type="number" value="60" min="1" max="1440">
</div>
<div class="form-group">
<label>Timeout (seg):</label>
<input type="number" value="10" min="1" max="60">
</div>
</div>
<div class="form-group">
<label>Sincroniza√ß√£o na Inicializa√ß√£o:</label>
<select>
<option value="enabled" selected>Habilitado</option>
<option value="disabled">Desabilitado</option>
</select>
</div>
<div class="form-group">
<label>Formato de Data:</label>
<select>
<option value="dd/mm/yyyy" selected>DD/MM/AAAA</option>
<option value="mm/dd/yyyy">MM/DD/AAAA</option>
<option value="yyyy-mm-dd">AAAA-MM-DD</option>
</select>
</div>
<div class="form-group">
<label>Formato de Hora:</label>
<select>
<option value="24h" selected>24 horas</option>
<option value="12h">12 horas (AM/PM)</option>
</select>
</div>
<button class="btn btn-primary" id="saveAdvanced">Salvar Configura√ß√µes</button>
<button class="btn btn-success" id="syncNow">Sincronizar Agora</button>
</div>

<!-- Debug Console NTP -->
<div id="debug" class="debug" style="display:block; margin-top: 30px;">
<div class="debug-header">
<span class="debug-title">üïê DEBUG NTP CONSOLE</span>
<div class="debug-controls">
<button class="debug-btn toggle" onclick="toggleDebugVisibility()">Minimizar</button>
<button class="debug-btn clear" onclick="clearDebug()">Limpar</button>
<button class="debug-btn disable" onclick="toggleDebugMode()">Desabilitar</button>
</div>
</div>
<div id="debugContent"></div>
</div>
</div>
<script>
// Verificar login
if(!sessionStorage.getItem('loggedIn')){
  window.location.href='login.html';
}

let ntpConfig = {};
let ntpStatus = {};
let debugMode = true; // Habilitar debug NTP
let debugVisible = true;

// Fun√ß√£o de debug para NTP
function debugLog(message) {
  if (debugMode) {
    console.log('üïê NTP DEBUG:', message);
    const debugDiv = document.getElementById('debugContent');
    const timestamp = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<span style="color:#6c757d">${timestamp}:</span> ${message}<br>`;
    
    if (debugVisible) {
      document.getElementById('debug').style.display = 'block';
    }
    
    // Auto-scroll para o final
    debugDiv.scrollTop = debugDiv.scrollHeight;
    
    // Limitar a 100 linhas para performance
    const lines = debugDiv.innerHTML.split('<br>');
    if (lines.length > 100) {
      debugDiv.innerHTML = lines.slice(-100).join('<br>');
    }
  }
}

function toggleDebugVisibility() {
  const debugDiv = document.getElementById('debug');
  const toggleBtn = document.querySelector('.debug-btn.toggle');
  
  if (debugVisible) {
    debugDiv.style.display = 'none';
    toggleBtn.textContent = 'Mostrar Debug';
    debugVisible = false;
    debugLog('Debug console minimizado');
  } else {
    debugDiv.style.display = 'block';
    toggleBtn.textContent = 'Minimizar';
    debugVisible = true;
    debugLog('Debug console restaurado');
  }
}

function clearDebug() {
  document.getElementById('debugContent').innerHTML = '';
  debugLog('Debug console limpo pelo usu√°rio');
}

function toggleDebugMode() {
  const disableBtn = document.querySelector('.debug-btn.disable');
  
  if (debugMode) {
    debugMode = false;
    disableBtn.textContent = 'Habilitar';
    disableBtn.style.background = '#dc3545';
    document.getElementById('debug').style.display = 'none';
    console.log('üïê NTP Debug mode DESABILITADO');
  } else {
    debugMode = true;
    disableBtn.textContent = 'Desabilitar';
    disableBtn.style.background = '#28a745';
    debugLog('NTP Debug mode HABILITADO novamente');
  }
}

// Atualizar display de tempo do ESP32
function updateTime() {
  debugLog('üîÑ Solicitando status NTP do ESP32...');
  
  fetch('/api/ntp/status')
    .then(response => response.json())
    .then(data => {
      ntpStatus = data;
      debugLog(`üì° Status recebido: ${data.synchronized ? 'Sincronizado' : 'N√£o sincronizado'} | Uptime: ${Math.floor(data.uptime/60)} min`);
      
      if (data.synchronized) {
        // Usar tempo do ESP32 se sincronizado
        const serverTime = new Date(data.currentTime);
        const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
        const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
        
        document.getElementById('currentTime').textContent = serverTime.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('currentDate').textContent = serverTime.toLocaleDateString('pt-BR', dateOptions);
        
        // Atualizar status
        document.querySelector('.status-info').innerHTML = 
          `‚úÖ <strong>Status:</strong> Sincronizado | √öltima sincroniza√ß√£o: ${data.lastSync} | Uptime: ${Math.floor(data.uptime/60)} min`;
        
        debugLog(`‚úÖ Tempo sincronizado exibido: ${serverTime.toLocaleString('pt-BR')}`);
      } else {
        // Fallback para tempo local do navegador
        const now = new Date();
        const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
        const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
        
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', dateOptions);
        
        document.querySelector('.status-info').innerHTML = 
          `‚ö†Ô∏è <strong>Status:</strong> N√£o sincronizado | Aguardando conex√£o NTP | Uptime: ${Math.floor(data.uptime/60)} min`;
        
        debugLog(`‚ö†Ô∏è NTP n√£o sincronizado, usando tempo local do navegador: ${now.toLocaleString('pt-BR')}`);
      }
    })
    .catch(error => {
      console.error('Erro ao obter status NTP:', error);
      debugLog(`‚ùå Erro ao obter status NTP: ${error.message}`);
      
      // Fallback para tempo local
      const now = new Date();
      const timeOptions = {hour:'2-digit',minute:'2-digit',second:'2-digit'};
      const dateOptions = {weekday:'long',year:'numeric',month:'long',day:'numeric'};
      
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', timeOptions);
      document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', dateOptions);
      
      debugLog(`üîÑ Fallback para tempo local ativado: ${now.toLocaleString('pt-BR')}`);
    });
}

// Carregar configura√ß√µes NTP
async function loadNtpConfig() {
  debugLog('üîÑ Carregando configura√ß√µes NTP do ESP32...');
  
  try {
    const response = await fetch('/api/ntp/config');
    const data = await response.json();
    ntpConfig = data;
    
    debugLog(`üì• Configura√ß√µes recebidas: Servidor1="${data.server1}" | Servidor2="${data.server2}" | Servidor3="${data.server3}" | Intervalo=${Math.floor(data.syncInterval / 60)}min`);
    
    // Preencher campos com configura√ß√µes reais
    document.querySelector('input[placeholder="pool.ntp.org"]').value = data.server1 || 'pool.ntp.org';
    document.querySelector('input[placeholder="time.google.com"]').value = data.server2 || 'time.google.com';
    document.querySelector('input[placeholder="time.cloudflare.com"]').value = data.server3 || 'time.cloudflare.com';
    
    // Preencher outros campos
    document.querySelector('input[type="number"][value="60"]').value = Math.floor(data.syncInterval / 60) || 60;
    
    console.log('‚úÖ Configura√ß√µes NTP carregadas:', data);
    debugLog('‚úÖ Campos da interface preenchidos com dados do ESP32');
  } catch (error) {
    console.error('‚ùå Erro ao carregar configura√ß√µes NTP:', error);
    debugLog(`‚ùå Erro ao carregar configura√ß√µes: ${error.message}`);
    showMessage('Erro ao carregar configura√ß√µes NTP', 'error');
  }
}

// Salvar configura√ß√µes NTP
async function saveNtpConfig() {
  debugLog('üíæ Preparando salvamento das configura√ß√µes NTP...');
  
  try {
    const server1 = document.querySelector('input[placeholder="pool.ntp.org"]').value;
    const server2 = document.querySelector('input[placeholder="time.google.com"]').value;
    const server3 = document.querySelector('input[placeholder="time.cloudflare.com"]').value;
    const syncInterval = parseInt(document.querySelector('input[type="number"][value="60"]').value) * 60;
    
    const config = {
      enabled: true,
      server1: server1,
      server2: server2,
      server3: server3,
      timezone: "America/Sao_Paulo",
      syncInterval: syncInterval
    };
    
    debugLog(`üì§ Enviando configura√ß√µes: Servidor1="${server1}" | Servidor2="${server2}" | Servidor3="${server3}" | Intervalo=${syncInterval/60}min`);
    
    const response = await fetch('/api/ntp/config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(config)
    });
    
    const result = await response.json();
    
    if (result.success) {
      showMessage('Configura√ß√µes NTP salvas com sucesso!', 'success');
      console.log('‚úÖ Configura√ß√µes NTP salvas');
      debugLog('‚úÖ Configura√ß√µes NTP salvas no ESP32 com sucesso');
    } else {
      showMessage('Erro ao salvar configura√ß√µes: ' + result.error, 'error');
      debugLog(`‚ùå Erro retornado pelo ESP32: ${result.error}`);
    }
  } catch (error) {
    console.error('‚ùå Erro ao salvar configura√ß√µes NTP:', error);
    debugLog(`‚ùå Erro de comunica√ß√£o ao salvar: ${error.message}`);
    showMessage('Erro ao salvar configura√ß√µes NTP', 'error');
  }
}

// For√ßar sincroniza√ß√£o NTP
async function syncNow() {
  debugLog('üîÑ Iniciando sincroniza√ß√£o NTP manual...');
  
  try {
    showMessage('Iniciando sincroniza√ß√£o NTP...', 'info');
    
    const response = await fetch('/api/ntp/sync', {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showMessage('Sincroniza√ß√£o NTP iniciada!', 'success');
      debugLog('‚úÖ Comando de sincroniza√ß√£o manual enviado ao ESP32');
      setTimeout(() => {
        debugLog('‚è±Ô∏è Atualizando status ap√≥s sincroniza√ß√£o manual...');
        updateTime();
      }, 2000); // Atualizar status ap√≥s 2 segundos
    } else {
      showMessage('Erro na sincroniza√ß√£o: ' + result.error, 'error');
      debugLog(`‚ùå Erro na sincroniza√ß√£o manual: ${result.error}`);
    }
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o NTP:', error);
    debugLog(`‚ùå Erro de comunica√ß√£o na sincroniza√ß√£o: ${error.message}`);
    showMessage('Erro na sincroniza√ß√£o NTP', 'error');
  }
}

// Fun√ß√£o para mostrar mensagens
function showMessage(message, type = 'info') {
  const statusDiv = document.querySelector('.status-info');
  const originalContent = statusDiv.innerHTML;
  
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  statusDiv.innerHTML = `${icon} <strong>Status:</strong> ${message}`;
  statusDiv.className = `status-info ${type}`;
  
  // Restaurar ap√≥s 3 segundos
  setTimeout(() => {
    statusDiv.innerHTML = originalContent;
    statusDiv.className = 'status-info';
  }, 3000);
}

// Event listeners para bot√µes
document.addEventListener('DOMContentLoaded', () => {
  debugLog('üöÄ P√°gina NTP carregada - Inicializando interface...');
  
  // Bot√£o Salvar Servidores
  document.getElementById('saveServers').onclick = saveNtpConfig;
  
  // Bot√£o Sincronizar Agora
  document.getElementById('syncNow').onclick = syncNow;
  
  // Bot√£o Salvar Fuso
  document.getElementById('saveTimezone').onclick = saveNtpConfig;
  
  // Bot√£o Salvar Configura√ß√µes Avan√ßadas
  document.getElementById('saveAdvanced').onclick = saveNtpConfig;
  
  // Bot√£o Testar Conectividade
  document.getElementById('testConnectivity').onclick = () => {
    debugLog('üîß Testando conectividade com servidores NTP...');
    showMessage('Testando conectividade NTP...', 'info');
    // Implementar teste de conectividade
  };
  
  // Carregar configura√ß√µes iniciais
  loadNtpConfig();
  
  debugLog('‚úÖ Event listeners configurados - Interface NTP pronta');
});

// Inicializar
debugLog('üïê Sistema de debug NTP ativado');
updateTime();
setInterval(() => {
  debugLog('‚è∞ Atualiza√ß√£o autom√°tica de status (intervalo 10s)');
  updateTime();
}, 10000); // Atualizar a cada 10 segundos
</script>
</body>
</html> 